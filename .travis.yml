jobs:
- language: rust
  rust:
    - stable
- language: rust
  rust:
    - stable
  services:
    - docker
  before_install:
    - docker pull clux/muslrust
  script:
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo clippy
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo clippy --features="async"
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo clippy --features="ptr"
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo clippy --features="async ptr"
    # Test with cartesian product of features: async on/off and ptr on/off
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo test
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo test --features="async"
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo test --features="ptr"
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo test --features="async ptr"

    # Build static executable with the Async feature (and not pointer feature)
    - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo build --release --all-targets --features="async ptr"
  deploy:
    - provider: releases
      file:
        - "target/x86_64-unknown-linux-musl/release/rmesg"
      on:
        tags: true
      edge: true
